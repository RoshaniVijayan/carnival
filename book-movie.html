<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Books & Movies - Halloween Carnival Banasthali</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family:"Trebuchet MS", sans-serif; background:#0d0d0d; color:#f8f8f8; }
    header { background:#111; padding:1rem 2rem; display:flex; align-items:center; justify-content:space-between; }
    header h1 { margin:0; color:#ff6a00; font-size:1.2rem; }
    nav a { color:#fff; text-decoration:none; margin-left:1rem; font-weight:bold; }
    .container { max-width:1000px; margin:2rem auto; padding:0 1rem; }
    .grid { display:grid; grid-template-columns:1fr 320px; gap:1rem; }
    .list { background:#1a1a1a; padding:1rem; border-radius:8px; box-shadow:0 0 12px #ff6a00aa; }
    .book { border-bottom:1px solid #2a2a2a; padding:0.8rem 0; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .book:last-child { border-bottom:none; }
    .book h3 { margin:0; color:#ff6a00; font-size:1rem; }
    .book .meta { color:#cfcfcf; font-size:0.92rem; }
    .movie { margin-bottom:1rem; padding:0.6rem; background:#111; border-radius:6px; }
    .sidebar { background:#1a1a1a; padding:1rem; border-radius:8px; box-shadow:0 0 12px #ff6a0066; }
    footer { text-align:center; padding:1rem; background:#0b0b0b; color:rgb(255,0,0); margin-top:2rem; }
    .btn { background:#ff6a00; color:#111; padding:0.5rem 0.8rem; border-radius:6px; text-decoration:none; font-weight:bold; display:inline-block; border:none; cursor:pointer; }
    .btn.secondary { background:#222; color:#fff; }
    .small { color:#cfcfcf; font-size:0.9rem; margin:0.25rem 0 0 0; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#0f0f0f; border-radius:10px; padding:18px; width:clamp(320px, 90%, 520px); box-shadow:0 8px 28px rgba(0,0,0,0.7); color:#fff; }
    .modal h3 { margin:0 0 8px 0; color:#ff6a00; }
    .field { margin:8px 0; display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:0.9rem; color:#ddd; }
    .field input, .field select { padding:8px 10px; border-radius:6px; border:1px solid #333; background:#0b0b0b; color:#fff; }
    .modal .actions { margin-top:12px; display:flex; gap:8px; justify-content:flex-end; }
    .error { color:#ff9b9b; font-size:0.9rem; margin-top:6px; display:none; }

    @media (max-width:900px) {
      .grid { grid-template-columns:1fr; }
      .sidebar { order:2; }
    }
  </style>

  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <h1>ðŸŽƒ Banasthali Carnival â€” Books & Movies</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="tickets.html">Tickets</a>
      <a href="book-movie.html">Books & Movies</a>
      <a href="merch.html">Merch</a>
    </nav>
  </header>

  <div class="container">
    <div style="text-align:left; color:#ff6a00; margin-bottom:0.8rem;"><h2>Classic Horror Books & Festival Movie Screenings</h2></div>

    <div class="grid">
      <div class="list" aria-label="books list">
        <h3 style="color:#ff6a00;">Featured Book Fair</h3>

        <div class="book" data-item-id="book-gothic" data-item-type="book">
          <div>
            <h3>Collected Gothic Tales</h3>
            <p class="small">Curated selection of gothic short stories. Stall: A3.</p>
          </div>
          <div>
            <button class="btn action-reserve" data-action="reserve" data-title="Collected Gothic Tales">Reserve Copy</button>
          </div>
        </div>

        <div class="book" data-item-id="book-dracula" data-item-type="book">
          <div>
            <h3>Horror Classics: Dracula & More</h3>
            <p class="small">New editions and local translations available. Stall: B1.</p>
          </div>
          <div>
            <button class="btn action-reserve" data-action="reserve" data-title="Horror Classics: Dracula & More">Reserve Copy</button>
          </div>
        </div>

        <div class="book" data-item-id="book-local" data-item-type="event">
          <div>
            <h3>Local Authors â€” Spooky Shortlists</h3>
            <p class="small">Meet-and-greet at 7 PM on 29 Oct (costume recommended).</p>
          </div>
          <div>
            <button class="btn action-bookseat" data-action="bookseat" data-title="Local Authors â€” Spooky Shortlists">Book Seat</button>
          </div>
        </div>
      </div>

      <aside class="sidebar" aria-label="movie schedule">
        <h3 style="color:#ff6a00;">Outdoor Movie Nights</h3>

        <div class="movie" data-movie-id="movie-dracula" data-movie-date="2025-10-30">
          <strong>30 Oct â€” Dracula</strong>
          <p class="small">Screening starts at 8 PM. Free seating; blankets suggested.</p>
          <div style="margin-top:8px;">
            <button class="btn action-bookmovie" data-action="bookmovie" data-title="Dracula" data-date="2025-10-30">Book Movie Seat</button>
          </div>
        </div>

        <div class="movie" data-movie-id="movie-shorts" data-movie-date="2025-10-31">
          <strong>31 Oct â€” Classic Horror Short Films</strong>
          <p class="small">Short film block at 9 PM. Family friendly block early evening.</p>
          <div style="margin-top:8px;">
            <button class="btn action-bookmovie" data-action="bookmovie" data-title="Classic Horror Short Films" data-date="2025-10-31">Book Movie Seat</button>
          </div>
        </div>

        <div class="movie" data-movie-id="movie-anthology" data-movie-date="2025-11-01">
          <strong>1 Nov â€” Festival Wrap: Horror Anthology</strong>
          <p class="small">Highlights and audience vote for favourite short.</p>
          <div style="margin-top:8px;">
            <button class="btn action-bookmovie" data-action="bookmovie" data-title="Horror Anthology" data-date="2025-11-01">Book Movie Seat</button>
          </div>
        </div>

      </aside>
    </div>

    <section style="margin-top:1rem;" class="list">
      <h3 style="color:#ff6a00;">Vendor Info (For book sellers)</h3>
      <p class="small">Stall booking is managed by the carnival committee. Vendors should bring their own tables and lighting. Contact: books@banasthali-carnival.example (replace with real contact when available).</p>
    </section>
  </div>

  <footer>&copy; 2025 Banasthali Halloween Carnival | All Rights Reserved</footer>

  <!-- Modal template (hidden until needed) -->
  <div id="modalRoot" style="display:none;">
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <h3 id="modalTitle">Reserve / Book</h3>

        <form id="modalForm">
          <input type="hidden" id="modalAction" name="action" value="">
          <input type="hidden" id="modalItemId" name="itemId" value="">
          <input type="hidden" id="modalItemTitle" name="itemTitle" value="">
          <div class="field">
            <label for="name">Your full name *</label>
            <input id="name" name="name" type="text" required placeholder="Jane Doe">
          </div>
          <div class="field">
            <label for="email">Email *</label>
            <input id="email" name="email" type="email" required placeholder="you@example.com">
          </div>
          <div class="field">
            <label for="phone">Phone *</label>
            <input id="phone" name="phone" type="tel" required placeholder="+91 98765 43210">
          </div>

          <div class="field" id="extraFieldContainer" style="display:none;">
            <label id="extraLabel" for="extraInput">Quantity / Seats</label>
            <input id="extraInput" name="extra" type="number" min="1" value="1">
          </div>

          <div class="actions">
            <button type="button" class="btn secondary" id="modalCancel">Cancel</button>
            <button type="submit" class="btn" id="modalSubmit">Confirm</button>
          </div>
          <div class="error" id="modalError">Please fill in required fields.</div>
        </form>
      </div>
    </div>
  </div>

  <!-- Minimal offline QR generator (compact, canvas-based) -->
  <script>
  (function(global){
    var qrcode = (function() {
      function makeMatrix(text) {
        var version = 4;
        var moduleCount = 17 + 4 * version;
        var modules = new Array(moduleCount);
        for(var i=0;i<moduleCount;i++){ modules[i]=new Array(moduleCount); for(var j=0;j<moduleCount;j++) modules[i][j]=null; }
        function placeFinderPattern(r,c){
          for(var rr=-1;rr<=7;rr++){
            if (r+rr<=-1 || moduleCount<=r+rr) continue;
            for(var cc=-1;cc<=7;cc++){
              if (c+cc<=-1 || moduleCount<=c+cc) continue;
              if ((0<=rr && rr<=6 && (cc==0||cc==6)) || (0<=cc && cc<=6 && (rr==0||rr==6)) || (2<=rr && rr<=4 && 2<=cc && cc<=4))
                modules[r+rr][c+cc]=true;
              else
                modules[r+rr][c+cc]=false;
            }
          }
        }
        placeFinderPattern(0,0);
        placeFinderPattern(moduleCount-7,0);
        placeFinderPattern(0,moduleCount-7);
        for(var i=8;i<moduleCount-8;i++){
          if (modules[i][6] == null) modules[i][6] = (i % 2 == 0);
          if (modules[6][i] == null) modules[6][i] = (i % 2 == 0);
        }
        function utf8bytes(s){
          var out=[];
          for(var j=0;j<s.length;j++){
            var c=s.charCodeAt(j);
            if (c<128) out.push(c);
            else if (c<2048){ out.push(192|(c>>6)); out.push(128|(c&63)); }
            else { out.push(224|(c>>12)); out.push(128|((c>>6)&63)); out.push(128|(c&63)); }
          }
          return out;
        }
        var dataBytes = utf8bytes(text);
        var maxData = Math.floor((moduleCount*moduleCount)/8) - 20;
        if (dataBytes.length > maxData) { dataBytes = dataBytes.slice(0, maxData); }
        var bits = [];
        for(var i=0;i<dataBytes.length;i++){
          for(var b=7;b>=0;b--) bits.push((dataBytes[i]>>b)&1);
        }
        while(bits.length < moduleCount*moduleCount - 64) bits.push(0);
        var dirUp = true;
        var x = moduleCount - 1;
        var bitIndex = 0;
        while(x > 0){
          if (x == 6) x--;
          for(var i=0;i<moduleCount;i++){
            var yy = dirUp ? moduleCount -1 - i : i;
            for(var col = 0; col < 2; col++){
              var xx = x - col;
              if (modules[yy][xx] === null){
                modules[yy][xx] = (bits[bitIndex] === 1);
                bitIndex++;
                if (bitIndex >= bits.length) { bitIndex = bits.length; }
              }
            }
          }
          dirUp = !dirUp;
          x -= 2;
        }
        for(var r=0;r<moduleCount;r++) for(var c=0;c<moduleCount;c++) if (modules[r][c] === null) modules[r][c] = false;
        return {modules:modules, size:moduleCount};
      }
      function toDataURL(text, size, margin, colorDark, colorLight) {
        size = size || 300;
        margin = (typeof margin === 'number') ? margin : 8;
        colorDark = colorDark || '#000';
        colorLight = colorLight || '#fff';
        var mat = makeMatrix(text);
        var moduleCount = mat.size;
        var canvas = document.createElement('canvas');
        var scale = Math.floor((size - margin*2) / moduleCount);
        if (scale < 1) scale = 1;
        var canvasSize = moduleCount * scale + margin*2;
        canvas.width = canvasSize;
        canvas.height = canvasSize;
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = colorLight;
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = colorDark;
        for(var r=0;r<moduleCount;r++){
          for(var c=0;c<moduleCount;c++){
            if (mat.modules[r][c]) {
              ctx.fillRect(margin + c*scale, margin + r*scale, scale, scale);
            }
          }
        }
        return canvas.toDataURL('image/png');
      }
      return { toDataURL: toDataURL };
    })();
    global.MinimalQR = qrcode;
  })(this);
  </script>

<script>
(function(){
  function $(sel, ctx){ return (ctx || document).querySelector(sel); }
  function $all(sel, ctx){ return Array.from((ctx || document).querySelectorAll(sel)); }
  function id(x){ return document.getElementById(x); }

  const modalRoot = document.getElementById('modalRoot');
  const modalBackdrop = id('modalBackdrop');
  const modalForm = id('modalForm');
  const modalAction = id('modalAction');
  const modalItemId = id('modalItemId');
  const modalItemTitle = id('modalItemTitle');
  const modalTitleEl = id('modalTitle');
  const extraFieldContainer = id('extraFieldContainer');
  const extraLabel = id('extraLabel');
  const extraInput = id('extraInput');
  const modalError = id('modalError');

  $all('.action-reserve').forEach(btn => btn.addEventListener('click', (e) => openModalFor(e.currentTarget, 'reserve')));
  $all('.action-bookseat').forEach(btn => btn.addEventListener('click', (e) => openModalFor(e.currentTarget, 'bookseat')));
  $all('.action-bookmovie').forEach(btn => btn.addEventListener('click', (e) => openModalFor(e.currentTarget, 'bookmovie')));

  id('modalCancel').addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', function(e){
    if (e.target === modalBackdrop) closeModal();
  });

  function openModalFor(target, actionType){
    const parent = target.closest('[data-item-id], .movie, .book') || target.parentElement;
    let itemId = parent && (parent.getAttribute('data-item-id') || parent.getAttribute('data-movie-id')) || '';
    let title = target.getAttribute('data-title') || parent.querySelector('h3, strong')?.textContent?.trim() || '';
    let date = target.getAttribute('data-date') || parent.getAttribute('data-movie-date') || '';

    modalAction.value = actionType;
    modalItemId.value = itemId || '';
    modalItemTitle.value = title || '';

    if (actionType === 'reserve'){
      modalTitleEl.textContent = 'Reserve copy â€” ' + (title || '');
      extraLabel.textContent = 'Quantity';
      extraInput.type = 'number';
      extraInput.min = 1;
      extraInput.value = 1;
      extraFieldContainer.style.display = '';
    } else if (actionType === 'bookseat'){
      modalTitleEl.textContent = 'Book seat â€” ' + (title || '');
      extraLabel.textContent = 'Number of seats';
      extraInput.type = 'number';
      extraInput.min = 1;
      extraInput.value = 1;
      extraFieldContainer.style.display = '';
    } else if (actionType === 'bookmovie'){
      modalTitleEl.textContent = 'Book movie seat â€” ' + (title || '');
      extraLabel.textContent = 'Number of seats';
      extraInput.type = 'number';
      extraInput.min = 1;
      extraInput.value = 1;
      extraFieldContainer.style.display = '';
    } else {
      modalTitleEl.textContent = 'Reserve / Book';
      extraFieldContainer.style.display = 'none';
    }

    modalForm.reset();
    modalError.style.display = 'none';
    modalRoot.style.display = 'block';
    // focus on name field
    setTimeout(()=> id('name').focus(),120);
  }

  function closeModal(){ modalRoot.style.display = 'none'; }

  function isValidEmail(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
  function isValidPhone(phone){ const digits = phone.replace(/\D/g,''); return digits.length >= 7; }

  // Helper: generate & download PDF ticket (uses jsPDF)
  async function generateAndDownloadPDF(payload, qrDataUrl) {
    try {
      // ensure jsPDF loaded
      if (!window.jspdf) {
        // try to wait briefly
        await new Promise((res) => setTimeout(res, 250));
        if (!window.jspdf) {
          console.warn('jsPDF not available â€” skipping PDF generation');
          return false;
        }
      }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });

      // Layout constants
      const left = 36;
      let y = 40;
      const pageWidth = doc.internal.pageSize.getWidth();
      const ticketW = pageWidth - left * 2;

      // Header
      doc.setFillColor(16,16,16);
      doc.rect(left, y-8, ticketW, 70, 'F'); // header background
      doc.setFontSize(20);
      doc.setTextColor(255,106,0);
      doc.text('Banasthali Halloween Carnival', left + 12, y + 10);
      doc.setFontSize(10);
      doc.setTextColor(200,200,200);
      doc.text('Books & Movies â€” Official Ticket', left + 12, y + 30);
      doc.setTextColor(255,255,255);
      y += 72;

      // Ticket box
      doc.setDrawColor(0);
      doc.setLineWidth(0.6);
      doc.roundedRect(left, y, ticketW, 320, 6, 6);
      const pad = 14;
      let cx = left + pad;
      let cy = y + pad;

      // Left column: details
      doc.setFontSize(12);
      doc.setTextColor(34,34,34);
      doc.text('Order ID:', cx, cy + 2);
      doc.setFontSize(14);
      doc.setTextColor(0);
      doc.text(String(payload.orderId), cx + 80, cy + 2);

      cy += 24;
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text('Item:', cx, cy);
      doc.setFontSize(13);
      doc.setTextColor(0);
      doc.text(String(payload.itemTitle), cx + 80, cy);

      cy += 20;
      doc.setFontSize(11);
      doc.text('Quantity / Seats:', cx, cy);
      doc.setFontSize(13);
      doc.text(String(payload.quantity), cx + 120, cy);

      cy += 22;
      doc.setFontSize(11);
      doc.text('Name:', cx, cy);
      doc.setFontSize(12);
      doc.text(String(payload.name), cx + 80, cy);

      cy += 18;
      doc.setFontSize(11);
      doc.text('Email:', cx, cy);
      doc.setFontSize(12);
      doc.text(String(payload.email), cx + 80, cy);

      cy += 18;
      doc.setFontSize(11);
      doc.text('Phone:', cx, cy);
      doc.setFontSize(12);
      doc.text(String(payload.phone), cx + 80, cy);

      cy += 30;
      doc.setFontSize(10);
      doc.setTextColor(120,120,120);
      doc.text('Issued:', cx, cy);
      doc.setFontSize(11);
      doc.setTextColor(0);
      doc.text(new Date(payload.issuedAt).toLocaleString(), cx + 56, cy);

      // Right column: QR
      const qrX = left + ticketW - pad - 160;
      const qrY = y + pad;
      if (qrDataUrl) {
        try {
          doc.addImage(qrDataUrl, 'PNG', qrX, qrY, 140, 140);
        } catch (e) {
          console.warn('Failed to embed QR in PDF', e);
        }
      } else {
        doc.setFontSize(10);
        doc.setTextColor(150,0,0);
        doc.text('QR unavailable', qrX + 18, qrY + 80);
      }

      // Footer note and barcode-like line
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text('Present this ticket (printed or digital) at the collection point. Staff will scan the QR to validate.', left + 12, y + 280);

      // Save file
      const filename = `ticket-${String(payload.orderId).replace(/[^a-zA-Z0-9-_]/g,'')}.pdf`;
      doc.save(filename);
      return true;
    } catch (err) {
      console.error('PDF generation error', err);
      return false;
    }
  }

  // Main modal submit handler â€” now async so it can generate+download PDF before opening confirmation
  modalForm.addEventListener('submit', async function(e){
    e.preventDefault();
    modalError.style.display = 'none';

    const action = modalAction.value;
    const itemId = modalItemId.value || '';
    const title = modalItemTitle.value || '';
    const name = id('name').value.trim();
    const email = id('email').value.trim();
    const phone = id('phone').value.trim();
    const extra = (extraInput && extraInput.value) ? Number(extraInput.value) : 1;

    if (!name || !email || !phone){
      modalError.textContent = 'Please fill all required fields (name, email, phone).';
      modalError.style.display = '';
      return;
    }
    if (!isValidEmail(email)){
      modalError.textContent = 'Please enter a valid email address.';
      modalError.style.display = '';
      return;
    }
    if (!isValidPhone(phone)){
      modalError.textContent = 'Please enter a valid phone number.';
      modalError.style.display = '';
      return;
    }

    const orderId = (action === 'reserve' ? 'RESV-' : action === 'bookseat' ? 'SEAT-' : 'MOV-' ) + Date.now();
    const now = new Date();
    const issued = now.toISOString();

    let itemLabel = title;
    if (!itemLabel){
      if (action === 'reserve') itemLabel = 'Book Item';
      else if (action === 'bookseat') itemLabel = 'Event Seat';
      else if (action === 'bookmovie') itemLabel = 'Movie Seat';
    }
    const extraLabelText = (action === 'reserve') ? 'Copies' : 'Seats';

    const qrPayload = {
      orderId: orderId,
      action: action,
      itemId: itemId,
      itemTitle: itemLabel,
      quantity: extra,
      name: name,
      email: email,
      phone: phone,
      issuedAt: issued
    };

    // Generate QR data URL (offline)
    let qrDataUrl = '';
    try {
      qrDataUrl = MinimalQR.toDataURL(JSON.stringify(qrPayload), 280);
    } catch (err) {
      console.error('QR generation failed', err);
      qrDataUrl = '';
    }

    // Generate & download PDF ticket (automatically)
    try {
      await generateAndDownloadPDF(qrPayload, qrDataUrl);
    } catch (err) {
      console.warn('PDF download attempt failed:', err);
    }

    // Build confirmation HTML (with embedded QR and a Download button)
    // To keep the confirmation page self-contained we embed the QR via encodeURIComponent
    const encodedQR = encodeURIComponent(qrDataUrl || '');
    const confirmationHtml = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Confirmation â€” ${escapeHtml(itemLabel)}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Trebuchet MS", Arial, sans-serif; margin:0; padding:24px; background:#fff; color:#111; }
    .box { max-width:760px; margin:0 auto; border:1px solid #ddd; padding:18px; border-radius:10px; }
    h1 { margin:0 0 8px 0; color:#ff6a00; font-size:22px; }
    .muted { color:#666; margin-top:6px; }
    .grid { display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; align-items:start; }
    .col { flex:1 1 220px; }
    .label { font-size:12px; color:#777; }
    .value { font-weight:700; margin-top:6px; }
    .actions { margin-top:18px; display:flex; gap:10px; justify-content:flex-end; }
    .btn { background:#ff6a00; color:#111; padding:10px 14px; border:none; border-radius:8px; font-weight:800; cursor:pointer; }
    .btn.secondary { background:#eee; color:#111; border:1px solid #ccc; }
    .note { margin-top:12px; color:#444; font-size:0.95rem; }
    .qr-wrap { flex:0 0 200px; text-align:center; }
    .qr-wrap img { max-width:100%; height:auto; border:1px solid #ddd; background:#fff; padding:6px; }
    pre{ background:#f7f7f7; padding:10px; border-radius:6px; overflow:auto; color:#222; }
    @media (max-width:620px){ .grid { flex-direction:column; } .actions { flex-direction:column-reverse; } .qr-wrap { order:-1; } }
  </style>
</head>
<body>
  <div class="box">
    <h1>Reservation Confirmed</h1>
    <div class="muted">Thank you â€” your ${escapeHtml(action === 'reserve' ? 'reservation' : action === 'bookseat' ? 'seat booking' : 'movie booking')} is recorded.</div>

    <div class="grid" style="margin-top:16px;">
      <div class="col">
        <div class="label">Order ID</div>
        <div class="value">${escapeHtml(orderId)}</div>

        <div style="margin-top:12px;">
          <div class="label">Item</div>
          <div class="value">${escapeHtml(itemLabel)}</div>
        </div>

        <div style="margin-top:12px;">
          <div class="label">${escapeHtml(extraLabelText)}</div>
          <div class="value">${escapeHtml(String(extra))}</div>
        </div>
      </div>

      <div class="col">
        <div class="label">Name</div>
        <div class="value">${escapeHtml(name)}</div>

        <div style="margin-top:12px;">
          <div class="label">Email</div>
          <div class="value">${escapeHtml(email)}</div>
        </div>

        <div style="margin-top:12px;">
          <div class="label">Phone</div>
          <div class="value">${escapeHtml(phone)}</div>
        </div>
      </div>

      <div class="qr-wrap" aria-hidden="${qrDataUrl ? 'false' : 'true'}">
        <div class="label">Scan to verify</div>
        ${ qrDataUrl ? `<img id="confirmQr" src="${qrDataUrl}" alt="Booking QR code">` : '<div style="color:#a00; margin-top:10px;">QR generation failed</div>' }
      </div>
    </div>

    <div class="note">
      <p>Please bring this confirmation (printed or on your phone) when you collect your copy / arrive for the event. Staff can scan the QR for quick verification. This is a demo confirmation generated in the browser â€” for production, keep a server-side record and sign QR payloads to prevent forging.</p>
      <pre style="margin-top:8px;">Issued: ${escapeHtml(new Date(issued).toLocaleString())}</pre>
    </div>

    <div class="actions">
      <button id="downloadBtn" class="btn">Download Ticket (PDF)</button>
      <button class="btn secondary" onclick="window.print()">Print / Save as PDF</button>
      <button class="btn secondary" onclick="window.close()">Close</button>
    </div>
  </div>

  <script>
    // recreate qrDataUrl inside confirmation window
    const qrDataUrl = decodeURIComponent("${encodeURIComponent(qrDataUrl || '')}");
    const payload = ${JSON.stringify(qrPayload)};
    async function downloadTicket() {
      try {
        if (!window.jspdf) {
          // load jsPDF dynamically if not present
          const s = document.createElement('script');
          s.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
          document.head.appendChild(s);
          await new Promise((res)=>{ s.onload = res; s.onerror = res; });
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });
        const left = 36;
        let y = 40;
        const pageWidth = doc.internal.pageSize.getWidth();
        const ticketW = pageWidth - left * 2;

        doc.setFillColor(16,16,16);
        doc.rect(left, y-8, ticketW, 70, 'F');
        doc.setFontSize(20);
        doc.setTextColor(255,106,0);
        doc.text('Banasthali Halloween Carnival', left + 12, y + 10);
        doc.setFontSize(10);
        doc.setTextColor(200,200,200);
        doc.text('Books & Movies â€” Official Ticket', left + 12, y + 30);
        y += 72;

        doc.roundedRect(left, y, ticketW, 320, 6, 6);
        const pad = 14;
        let cx = left + pad;
        let cy = y + pad;

        doc.setFontSize(12);
        doc.setTextColor(34,34,34);
        doc.text('Order ID:', cx, cy + 2);
        doc.setFontSize(14);
        doc.setTextColor(0);
        doc.text(String(payload.orderId), cx + 80, cy + 2);

        cy += 24;
        doc.setFontSize(11);
        doc.setTextColor(0);
        doc.text('Item:', cx, cy);
        doc.setFontSize(13);
        doc.setTextColor(0);
        doc.text(String(payload.itemTitle), cx + 80, cy);

        cy += 20;
        doc.setFontSize(11);
        doc.text('Quantity / Seats:', cx, cy);
        doc.setFontSize(13);
        doc.text(String(payload.quantity), cx + 120, cy);

        cy += 22;
        doc.setFontSize(11);
        doc.text('Name:', cx, cy);
        doc.setFontSize(12);
        doc.text(String(payload.name), cx + 80, cy);

        cy += 18;
        doc.setFontSize(11);
        doc.text('Email:', cx, cy);
        doc.setFontSize(12);
        doc.text(String(payload.email), cx + 80, cy);

        cy += 18;
        doc.setFontSize(11);
        doc.text('Phone:', cx, cy);
        doc.setFontSize(12);
        doc.text(String(payload.phone), cx + 80, cy);

        const qrX = left + ticketW - pad - 160;
        const qrY = y + pad;
        if (qrDataUrl) {
          try { doc.addImage(qrDataUrl, 'PNG', qrX, qrY, 140, 140); } catch(e){ console.warn('embed QR failed', e); }
        }

        doc.setFontSize(9);
        doc.setTextColor(120);
        doc.text('Present this ticket (printed or digital) at the collection point. Staff will scan the QR to validate.', left + 12, y + 280);

        const filename = `ticket-${String(payload.orderId).replace(/[^a-zA-Z0-9-_]/g,'')}.pdf`;
        doc.save(filename);
      } catch (err) {
        console.error('Download failed', err);
        alert('Unable to generate PDF in this browser.');
      }
    }

    document.getElementById('downloadBtn').addEventListener('click', downloadTicket);
    // If automatic download already happened, this still provides a manual download option
  </script>

</body>
</html>
    `.trim();

    // open confirmation page
    const w = window.open('', '_blank', 'noopener,noreferrer');
    if (!w) {
      alert('Popup blocked. Please allow popups to see the confirmation page.');
      return;
    }
    w.document.open();
    w.document.write(confirmationHtml);
    w.document.close();

    // close modal
    closeModal();
  });

  function escapeHtml(s){
    if (s === undefined || s === null) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }
})();
</script>
</body>
</html>
