<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Checkout — Banasthali Carnival Merch</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0d0d0d;--card:#111;--muted:#cfcfcf;--accent:#ff6a00;--panel:#1a1a1a}
    body{margin:0;font-family:"Trebuchet MS",sans-serif;background:var(--bg);color:#fff;display:flex;min-height:100vh;align-items:flex-start;justify-content:center;padding:20px}
    .container{width:100%;max-width:760px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{color:var(--accent);font-size:18px;margin:0}
    .card{background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,0.6)}
    form label{display:block;margin-top:12px;font-size:0.95rem}
    input[type="text"], input[type="email"], input[type="tel"], textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #2a2a2a;background:transparent;color:#fff;box-sizing:border-box}
    textarea{resize:vertical}
    .muted{color:var(--muted);font-size:0.9rem;margin-top:6px}
    .actions{display:flex;gap:10px;margin-top:18px;align-items:center}
    .btn{background:var(--accent);color:#111;padding:10px 14px;border-radius:8px;border:none;font-weight:700;cursor:pointer}
    .btn.secondary{background:#222;color:#fff;border:1px solid #333}
    .error{color:#ff7b7b;margin-top:8px}
    .summary{background:var(--panel);padding:12px;border-radius:8px;margin-top:14px;color:var(--muted);font-size:0.95rem}
    /* PayPal container */
    #paypal-container{margin-top:16px}
    .notice{color:#ddd;font-size:0.88rem;margin-top:8px}
    @media (max-width:520px){body{padding:12px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Checkout — Banasthali Carnival</h1>
      <a href="merch.html" style="color:var(--muted);text-decoration:none;">← Back to merch</a>
    </header>

    <div class="card" id="checkoutCard">
      <h2 style="margin:0 0 6px 0;color:var(--accent)">Shipping & Contact</h2>
      <div class="muted">Fill this form, then click <strong>PAY TO PROCEED</strong> to pay with PayPal.</div>

      <form id="checkoutForm" onsubmit="return false;" novalidate>
        <label for="name">Full name *</label>
        <input id="name" type="text" placeholder="Example: Roshani Vijayan" required>

        <label for="contact">Contact number *</label>
        <input id="contact" type="tel" inputmode="tel" placeholder="9876543210 or +91 98765-43210" required>
        <div class="muted">Only digits are stored; formatted for readability.</div>

        <label for="email">Email *</label>
        <input id="email" type="email" placeholder="you@example.com" required>

        <label for="address">Address *</label>
        <textarea id="address" rows="3" placeholder="House/street/city/pincode" required></textarea>

        <div class="summary" id="orderSummary" aria-live="polite">
          Loading cart summary...
        </div>

        <div id="formError" class="error" style="display:none"></div>

        <div class="actions">
          <button id="payProceed" class="btn" type="button">PAY TO PROCEED</button>
          <button id="clearAndBack" class="btn secondary" type="button">Clear & Back</button>
        </div>

        <div class="notice" id="gatewayNotice" style="display:none">
          Loading payment gateway... (Sandbox). For live mode, replace PayPal <code>client-id</code> on the script tag.
        </div>
      </form>

      <!-- PayPal buttons show here after validation -->
      <div id="paypalArea" style="display:none">
        <div id="paypal-container"></div>
        <div class="muted" style="margin-top:10px">After payment completes you'll see a confirmation and the local cart will be cleared.</div>
      </div>

      <div id="successMsg" style="display:none;margin-top:12px;padding:12px;border-radius:8px;background:rgba(0,128,0,0.08);color:#cfead0">
        <strong>Payment confirmed</strong>
        <div id="successDetails" style="margin-top:8px;color:#eaf6e8"></div>
      </div>
    </div>
  </div>

  <!-- 
    PayPal SDK:
    - Replace client-id=sb (sandbox) with your real client id when ready.
    - Change currency param if required: currency=USD (default here). Use 'INR' only if your PayPal account supports INR.
  -->
  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

  <script>
    // CONFIG: change these if you want
    const STORAGE_KEY = 'carnival_cart_v1';
    // PAYPAL currency for the integration. Keep 'USD' by default for general compatibility.
    // If you have a merchant account that supports INR, set PAYPAL_CURRENCY = 'INR'
    const PAYPAL_CURRENCY = 'USD';

    // Optional: set exchange rate if your cart totals are in INR and you use USD for PayPal.
    // Example: 1 USD = 83 INR. Adjust to real rate or configure server-side.
    const INR_TO_USD_RATE = 83.0;

    // Utility: read cart totals (cart stored as {id:qty})
    function loadCart() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error('cart parse', e);
        return {};
      }
    }

    // local product catalog copy (should match merch page)
    const PRODUCTS = {
      tshirt: { title: 'Event T-shirt', price: 399 },
      mug:    { title: 'Haunted Mug', price: 249 },
      mask:   { title: 'Souvenir Mask', price: 149 },
      badge:  { title: 'Collector Badge', price: 99 }
    };

    function computeTotals(cart) {
      let subtotalINR = 0;
      for (const [pid, qty] of Object.entries(cart)) {
        const p = PRODUCTS[pid];
        if (!p) continue;
        subtotalINR += p.price * Number(qty);
      }
      // Convert to payment currency amount:
      let amount = subtotalINR;
      if (PAYPAL_CURRENCY !== 'INR') {
        amount = (subtotalINR / INR_TO_USD_RATE);
      }
      // Round to 2 decimals (string)
      return { subtotalINR, amount: amount.toFixed(2) };
    }

    // Render small order summary
    function renderOrderSummary() {
      const cart = loadCart();
      const lines = [];
      for (const [pid, qty] of Object.entries(cart)) {
        const p = PRODUCTS[pid] || { title: pid, price: 0 };
        lines.push(`${p.title} x${qty} — ₹${p.price * qty}`);
      }
      const totals = computeTotals(cart);
      const summaryEl = document.getElementById('orderSummary');
      if (lines.length === 0) {
        summaryEl.innerHTML = '<strong>Cart is empty.</strong> Go back to merch and add items.';
      } else {
        summaryEl.innerHTML = `<strong>Items</strong><div style="margin-top:6px">${lines.join('<br>')}</div>
          <div style="margin-top:8px"><strong>Subtotal:</strong> ₹${totals.subtotalINR} — <em>${PAYPAL_CURRENCY} ${totals.amount} (for payment)</em></div>`;
      }
      return { cart, totals };
    }

    // Simple phone normalizer: keep digits, prefer last 10 digits for indian mobile
    function phoneDigits(value) {
      const d = (value || '').replace(/\D/g, '');
      if (d.length > 10) return d.slice(-10);
      return d;
    }

    // Basic form validation
    function validateForm() {
      const name = document.getElementById('name').value.trim();
      const contactRaw = document.getElementById('contact').value.trim();
      const contact = phoneDigits(contactRaw);
      const email = document.getElementById('email').value.trim();
      const address = document.getElementById('address').value.trim();

      if (!name) return 'Please enter full name.';
      if (!contact || contact.length !== 10) return 'Please enter a valid 10-digit contact number.';
      // basic email regex
      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      if (!emailOk) return 'Please enter a valid email address.';
      if (!address || address.length < 6) return 'Please enter a valid address.';
      // all good
      return null;
    }

    // Wire Pay To Proceed button
    document.getElementById('payProceed').addEventListener('click', () => {
      const err = validateForm();
      const formError = document.getElementById('formError');
      formError.style.display = 'none';
      if (err) {
        formError.textContent = err;
        formError.style.display = 'block';
        return;
      }

      // Save buyer details to sessionStorage (so paypal callback page can read if desired)
      const buyer = {
        name: document.getElementById('name').value.trim(),
        contact: phoneDigits(document.getElementById('contact').value.trim()),
        email: document.getElementById('email').value.trim(),
        address: document.getElementById('address').value.trim()
      };
      sessionStorage.setItem('carnival_buyer', JSON.stringify(buyer));

      // compute totals and load PayPal buttons
      const { cart, totals } = renderOrderSummary();
      if (Object.keys(cart).length === 0) {
        formError.textContent = 'Cart is empty. Add some items first.';
        formError.style.display = 'block';
        return;
      }

      // show notice and paypal area
      document.getElementById('gatewayNotice').style.display = 'block';
      document.getElementById('paypalArea').style.display = 'block';
      // disable pay proceed to prevent re-click
      document.getElementById('payProceed').disabled = true;
      // render PayPal buttons
      renderPayPalButtons(totals.amount, totals.subtotalINR, cart);
    });

    // Clear & Back button: clears cart and returns to merch page
    document.getElementById('clearAndBack').addEventListener('click', () => {
      if (confirm('Clear cart local data and go back to merch?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.href = 'merch.html';
      }
    });

    // PayPal button rendering
    function renderPayPalButtons(amountStr, subtotalINR, cartObj) {
      // remove any prior buttons
      const container = document.getElementById('paypal-container');
      container.innerHTML = '';

      // PayPal JS SDK should be loaded via script tag above.
      if (typeof paypal === 'undefined') {
        alert('PayPal SDK not loaded. Check your network or script tag.');
        return;
      }

      // create order with purchase_units set to amount in chosen currency
      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'rect', label: 'paypal' },
        createOrder: function(data, actions) {
          // IMPORTANT: For production, create the order server-side.
          return actions.order.create({
            purchase_units: [{
              amount: {
                currency_code: PAYPAL_CURRENCY,
                value: amountStr
              },
              description: `Banasthali Carnival merch order — ₹${subtotalINR}`
            }],
            application_context: {
              shipping_preference: 'NO_SHIPPING' // we collect address separately
            }
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            // Payment successful on PayPal side. Show confirmation and clear cart locally.
            const buyer = JSON.parse(sessionStorage.getItem('carnival_buyer') || '{}');
            const summaryLines = Object.entries(cartObj).map(([pid, qty]) => {
              const p = PRODUCTS[pid] || { title: pid, price: 0 };
              return `${p.title} x${qty} — ₹${p.price * qty}`;
            }).join('<br>');
            const successEl = document.getElementById('successMsg');
            const detailsEl = document.getElementById('successDetails');
            detailsEl.innerHTML = `<div><strong>Order paid via PayPal</strong></div>
              <div style="margin-top:6px">${summaryLines}</div>
              <div style="margin-top:8px"><strong>Total:</strong> ₹${subtotalINR}</div>
              <div style="margin-top:8px"><strong>Name:</strong> ${buyer.name}</div>
              <div><strong>Email:</strong> ${buyer.email}</div>
              <div><strong>Contact:</strong> ${buyer.contact}</div>
              <div style="margin-top:6px;color:#bfe8c9"><strong>PayPal payer:</strong> ${details.payer?.name?.given_name || ''} ${details.payer?.name?.surname || ''} (${details.payer?.email_address || ''})</div>
              <div style="margin-top:6px;color:#bfe8c9"><strong>PayPal order id:</strong> ${data.orderID}</div>`;
            successEl.style.display = 'block';

            // clear local cart
            localStorage.removeItem(STORAGE_KEY);

            // hide paypal buttons (optional)
            document.getElementById('paypalArea').style.display = 'none';
            // optionally, keep buyer info for admin download/processing
            // sessionStorage.setItem('lastOrder', JSON.stringify({buyer, cart:cartObj, totals:{subtotalINR}}));
          });
        },
        onError: function (err) {
          console.error('PayPal error', err);
          alert('Payment failed or was cancelled. See console for details.');
          document.getElementById('payProceed').disabled = false;
        }
      }).render('#paypal-container');
    }

    // initial render of summary on page load
    renderOrderSummary();

    // small phone input formatting UX: don't change digits, but show grouping
    (function attachPhoneFormatting(){
      const input = document.getElementById('contact');
      if(!input) return;
      input.addEventListener('input', () => {
        const raw = input.value.replace(/\D/g,'');
        // show last 10 digits grouped as 5-5 with optional +91 prefix if user typed it
        let display = raw;
        if (raw.length > 10) {
          if (raw.startsWith('91')) {
            const last10 = raw.slice(-10);
            display = '+91 ' + last10.slice(0,5) + '-' + last10.slice(5);
          } else {
            const last10 = raw.slice(-10);
            display = last10.slice(0,5) + '-' + last10.slice(5);
          }
        } else if (raw.length === 10) {
          display = raw.slice(0,5) + '-' + raw.slice(5);
        } else if (raw.length > 5) {
          display = raw.slice(0,5) + '-' + raw.slice(5);
        } else {
          display = raw;
        }
        input.value = display;
      });
      input.addEventListener('blur', () => {
        const raw = input.value.replace(/\D/g,'');
        if (raw.length >= 10) {
          if (raw.length > 10 && raw.startsWith('91')) input.value = '+91 ' + raw.slice(-10).slice(0,5) + '-' + raw.slice(-10).slice(5);
          else input.value = raw.slice(-10).slice(0,5) + '-' + raw.slice(-10).slice(5);
        }
      });
    })();
  </script>
</body>
</html>
